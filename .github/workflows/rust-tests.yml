name: Rust

on:
  push:
    branches:
    - main
    paths:
    - 'rust-core/**'
    - '.github/workflows/rust-tests.yml'
  pull_request:
    branches:
    - main
    paths:
    - 'rust-core/**'
    - '.github/workflows/rust-tests.yml'

jobs:
  check:
    name: ${{ matrix.check }} (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
        - macos-latest
        - ubuntu-latest
        check:
        - clippy
        - fmt
        - test
        - coverage-lcov

    steps:
    - uses: actions/checkout@v5

    - name: Install development tools (just)
      uses: taiki-e/install-action@v2
      with:
        tool: just

    - name: Install cargo-llvm-cov (faster)
      if: matrix.check == 'coverage-lcov'
      uses: taiki-e/install-action@v2
      with:
        tool: cargo-llvm-cov

    - name: Install Rust components
      run: just setup-rust

    - name: Cache cargo dependencies
      uses: actions/cache@v5
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          rust-core/target
        key: ${{ runner.os }}-cargo-${{ matrix.check }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-${{ matrix.check }}-
          ${{ runner.os }}-cargo-

    - name: Run Clippy
      if: matrix.check == 'clippy'
      run: just ${{ matrix.check }}

    - name: Check Rust code formatting
      if: matrix.check == 'fmt'
      run: just ${{ matrix.check }}

    - name: Run tests
      if: matrix.check == 'test'
      run: just ${{ matrix.check }} -v

    - name: Generate code coverage
      if: matrix.check == 'coverage-lcov'
      working-directory: rust-core
      run: just ${{ matrix.check }}

    - name: Upload coverage to Codecov
      if: matrix.check == 'coverage-lcov'
      uses: codecov/codecov-action@v5
      with:
        files: rust-core/lcov.info
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}
